{"changed":true,"filter":false,"title":"app.js","tooltip":"/auth/app.js","value":"var express = require(\"express\");  \nvar app = express();\nvar mongoose = require(\"mongoose\");                                             // database\nvar bodyPArser = require(\"body-parser\");                                        // for neat form\nvar passport = require(\"passport\");                                             // for login\nvar locol_passport = require(\"passport-local\");                                 // for login\nvar local_passport_mongo = require(\"passport-local-mongoose\");                  // for login\nvar method_override = require(\"method-override\");                               // to overwrite the post\n//var express_sanitizer = require(\"express-sanitizer\");                         // to clean and safty\nvar flash = require(\"connect-flash\");\n\n//var seedDb = require(\"./seeds\");                                              // seeding has some null error remenber come back to fix\n//seedDb();\n\napp.set(\"view engine\", \"ejs\");                                                  // for lazyness\nvar user = require(\"./models/users\");  \n//var blog = require(\"./models/blog\");          // include the file for clean page\napp.use(bodyPArser.urlencoded({extended:true}));\n//app.use(express_sanitizer());                                                  // remenber this one needs to be after the bodyparser\n\nmongoose.connect(\"mongodb://localhost/auth\", { useNewUrlParser: true, useUnifiedTopology: true});\napp.use(method_override(\"_method\"));\napp.use(flash());\n\n\napp.use(require(\"express-session\")({\n    secret:\"Rusty is the best\",\n    resave:false,\n    saveUninitialized:false\n}));\n\napp.use(passport.initialize());\napp.use(passport.session());\n\npassport.use(new locol_passport(user.authenticate()));\npassport.serializeUser(user.serializeUser());                       //encode\npassport.deserializeUser(user.deserializeUser());                   //decode\n\n////////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////\n\n\n\nvar blog_schema = new mongoose.Schema({\n  title:String,\n  URL: {type : String, default: \"https://akm-img-a-in.tosshub.com/sites/indiacontent/0/media/images/frontend/image-not-found.png\"},\n  content: String, \n  created: {type : Date, default: Date.now}\n});\n\nvar blog = mongoose.model(\"blog\", blog_schema);\n\n\n\n//////////////////////\n//      route\n//////////////////////\n\napp.get(\"/\", function(req, res){\n     blog.find({}, function(err, db){\n        if (err){\n            console.log(err);\n        }\n        else{\n            res.render(\"home\", {db : db});\n        }\n    });\n});\n\napp.post('/', function(req, res)\n{\n  var D_title = req.body.title;\n  var U_name = req.body.URL;\n  var U_Des = req.body.content;\n  var new_temp = {title : D_title, URL:U_name, content:U_Des};\n\n  blog.create(new_temp, \n  \n    function(err, pd)\n    {\n      if (err)\n      {\n        console.log(err);\n      }\n      else\n      {\n        res.redirect(\"/\");\n      }\n    }\n  );\n})\n\napp.get('/new', function (req, res) {\n   res.render(\"add_new\");\n});\n\napp.get(\"/secret\", is_login, function(req, res){\n   res.render(\"secret\");\n});\n\n//////////////////////\n//    auth route\n//////////////////////\n\napp.get(\"/register\", function(req, res){\n   res.render(\"register\");\n});\n\napp.post(\"/register\", function(req, res){\n\n    user.register(new user({username:req.body.username}), req.body.password, function(err, user){\n       \n        if (err)\n        {\n            console.log(err);\n            return res.render(\"register\");\n        }\n        \n        passport.authenticate(\"local\")(req, res, function(){\n        res.redirect(\"/secret\");\n        \n        });\n    });\n});\n\napp.get(\"/login\", function(req, res){\n   res.render(\"login\");\n});\n\napp.post(\"/login\", passport.authenticate(\"local\", {\n    successRedirect: \"/secret\",\n    failureRedirect: \"/login\"\n}), function(req, res){\n    \n});\n\napp.get(\"/logout\", function(req, res){\n   req.logout();\n   res.redirect(\"/\");\n});\n\nfunction is_login(req, res, next){\n    if (req.isAuthenticated())\n    {\n        return next();\n    }\n    \n    res.redirect(\"/login\");\n}\n\napp.delete('/:id', function (req, res) {\n  blog.findByIdAndRemove(req.params.id, function(err){\n      if (err)\n      {\n        res.redirect(\"/\");\n      }\n      else\n      {\n        res.redirect(\"/\");\n      }\n  });\n});\n\n\napp.get('/:id', function(req, res){\n    blog.findById(req.params.id, function(err, db)\n  {\n      if (err)\n      {\n        res.redirect(\"/\");\n      }\n      else\n      {\n        res.render(\"show\", {db : db});\n      }\n      \n  });\n});\n\n\napp.get('/:id/edit', is_login, function (req, res) {\n  blog.findById(req.params.id, function(err, db){\n      if (err)\n      {\n         res.redirect(\"/\");\n      }\n      else\n      {\n        res.render(\"edit\", {db : db});\n      }\n  });\n});\n\napp.put('/:id', function (req, res) {\n/*\n  console.log(req.body);\n  req.body.blog.body =  req.sanitize(req.body.blog.body);\n  console.log(\"================================================================\");\n  console.log(req.body);\n*/\n    \n  blog.findByIdAndUpdate(req.params.id, req.body.blog, function(err, updated_blog){\n      \n      if (err)\n      {\n         res.redirect(\"/\");\n      }\n      else\n      {\n        res.redirect(\"/\" + req.params.id);\n      }\n  });\n});\n\n\n////////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////\n\napp.get('*', function (req, res) {\n  res.send('Wrong page man!');\n});\n\napp.listen(process.env.PORT, process.env.IP, function()\n{\n console.log(\"Server has started!!\");\n});\n","undoManager":{"mark":-2,"position":5,"stack":[[{"start":{"row":92,"column":0},"end":{"row":92,"column":1},"action":"insert","lines":["<"],"id":1227},{"start":{"row":92,"column":1},"end":{"row":92,"column":2},"action":"insert","lines":["-"]},{"start":{"row":92,"column":2},"end":{"row":92,"column":3},"action":"insert","lines":["-"]}],[{"start":{"row":92,"column":1},"end":{"row":92,"column":2},"action":"insert","lines":["!"],"id":1228}],[{"start":{"row":92,"column":4},"end":{"row":92,"column":5},"action":"insert","lines":[" "],"id":1229},{"start":{"row":92,"column":5},"end":{"row":92,"column":6},"action":"insert","lines":["-"]},{"start":{"row":92,"column":6},"end":{"row":92,"column":7},"action":"insert","lines":["-"]},{"start":{"row":92,"column":7},"end":{"row":92,"column":8},"action":"insert","lines":[">"]}],[{"start":{"row":92,"column":7},"end":{"row":92,"column":8},"action":"remove","lines":[">"],"id":1230},{"start":{"row":92,"column":6},"end":{"row":92,"column":7},"action":"remove","lines":["-"]},{"start":{"row":92,"column":5},"end":{"row":92,"column":6},"action":"remove","lines":["-"]},{"start":{"row":92,"column":4},"end":{"row":92,"column":5},"action":"remove","lines":[" "]},{"start":{"row":92,"column":3},"end":{"row":92,"column":4},"action":"remove","lines":["-"]},{"start":{"row":92,"column":2},"end":{"row":92,"column":3},"action":"remove","lines":["-"]},{"start":{"row":92,"column":1},"end":{"row":92,"column":2},"action":"remove","lines":["!"]},{"start":{"row":92,"column":0},"end":{"row":92,"column":1},"action":"remove","lines":["<"]}],[{"start":{"row":112,"column":7},"end":{"row":112,"column":8},"action":"insert","lines":["a"],"id":1231}],[{"start":{"row":112,"column":7},"end":{"row":112,"column":8},"action":"remove","lines":["a"],"id":1232}]]},"ace":{"folds":[],"scrolltop":1159.984375,"scrollleft":0,"selection":{"start":{"row":112,"column":7},"end":{"row":112,"column":7},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1570575184091}